# Спецификация проекта

Добро пожаловать в техническую спецификацию проекта **jp-song-trainer**! Этот документ описывает архитектурные решения, API, модель данных и другие технические аспекты проекта.

| Параметр | Описание |
| -------- | -------- |
| **Продукт** | Web‑приложение для изучения японского языка через разбор текстов и песен |
| **Кодовое имя** | jp-song-trainer |
| **Методология** | Agile Scrum (итерации по 3 недели) |
| **Инструменты** | Confluence, Jira, GitHub, Docker |
| **Технологии (MVP)** | Vue 3 (Vite, Pinia), Go (Chi Router), PostgreSQL, TailwindCSS |
| **Аутентификация** | JWT + OAuth 2.0 (Google) |
| **Деплой (MVP)** | Docker-контейнеризация, развертывание на VPS |
| **UI‑палитра** | <span style="color: white; background-color: #a2d2ff">#a2d2ff</span> <span style="color: white; background-color: #bee2ff">#bee2ff</span> <span style="color: white; background-color: #faaac7">#faaac7</span> <span style="color: white; background-color: #ffc8dd">#ffc8dd</span> <span style="color: white; background-color: #cdb4db">#cdb4db</span> |

---

## 1. Функциональные требования (FR)

| Модуль | Функциональность | Приоритет |
|--------|------------------|-----------|
| **Аутентификация** | Регистрация и вход по email/паролю | MUST HAVE |
| **Управление материалами** | CRUD операции для материалов, управление статусами | MUST HAVE |
| **Личный словарь** | Добавление/удаление слов, просмотр словаря | MUST HAVE |
| **Система достижений** | 15 достижений, отслеживание прогресса | MUST HAVE |
| **Отчеты об ошибках** | Отправка отчетов на email модератора | MUST HAVE |
| **Интерфейс материалов** | Трехколоночный просмотр (оригинал/перевод/разбор) | MUST HAVE |
| **Фильтрация материалов** | Фильтрация по тегам сложности | SHOULD HAVE |

---

## 2. Нефункциональные требования (NFR)

| Аспект | Требование |
|--------|------------|
| **Производительность** | Время отклика API < 500 мс для 95% запросов |
| **Безопасность** | JWT аутентификация, хеширование паролей (bcrypt) |
| **Надежность** | Доступность 99% в рабочее время |
| **Масштабируемость** | Возможность горизонтального масштабирования |
| **Юзабилити** | Интуитивно понятный интерфейс, адаптивная верстка |
| **Совместимость** | Поддержка современных браузеров (Chrome, Firefox, Safari) |

---

## 1. Архитектура решения

**Frontend (Vue 3):**

- Vite + TypeScript
- Pinia (управление состоянием)
- Vue Router (навигация)
- TailwindCSS (стилизация)
- Axios (HTTP-клиент)

**Backend (Go):**

- Chi Router (роутинг)
- PostgreSQL (основная БД)
- JWT + OAuth (аутентификация)
- Zap (логирование)
- Docker-контейнеризация

**Взаимодействие:**

- REST API между фронтендом и бэкендом
- JWT для аутентификации запросов

---

## 4. Модель базы данных

### Сущности

| Сущность | Атрибут | Тип | Ограничения | Описание |
|----------|---------|-----|-------------|----------|
| **Users** | id | UUID | PK | Уникальный идентификатор пользователя |
|  | email | VARCHAR(255) | UNIQUE, NOT NULL | Email пользователя |
|  | password_hash | VARCHAR(255) | NOT NULL | Хеш пароля |
|  | role | VARCHAR(20) | DEFAULT 'user' | Роль: `user`, `moderator`, `admin` |
|  | created_at | TIMESTAMP | DEFAULT NOW() | Дата создания |
| **Materials** | id | UUID | PK | Уникальный идентификатор материала |
|  | title | VARCHAR(500) | NOT NULL | Название материала |
|  | description | TEXT | NULL | Описание материала |
|  | difficulty | VARCHAR(10) | NOT NULL | Уровень сложности: `easy`, `medium`, `hard` |
|  | status | VARCHAR(20) | DEFAULT 'draft' | Статус: `draft`, `published`, `archived` |
|  | created_by | UUID | FK -> users(id) | Автор материала |
|  | created_at | TIMESTAMP | DEFAULT NOW() | Дата создания |
| **MaterialBlocks** | id | UUID | PK | Уникальный идентификатор блока |
|  | material_id | UUID | FK -> materials(id) | Ссылка на материал |
|  | original_text | TEXT | NOT NULL | Оригинальный текст на японском |
|  | translated_text | TEXT | NOT NULL | Перевод на русский |
|  | grammar_breakdown | TEXT | NULL | Грамматический разбор блока |
|  | block_order | INTEGER | NOT NULL | Порядковый номер блока |
| **PersonalDictionaries** | id | UUID | PK | Уникальный идентификатор записи |
|  | user_id | UUID | FK -> users(id) | Владелец словаря |
|  | word | VARCHAR(255) | NOT NULL | Слово на японском |
|  | translation | VARCHAR(500) | NOT NULL | Перевод слова |
|  | notes | TEXT | NULL | Пользовательские заметки к слову |
|  | added_date | TIMESTAMP | DEFAULT NOW() | Дата добавления |
| **Achievements** | id | UUID | PK | Уникальный идентификатор достижения |
|  | name | VARCHAR(255) | NOT NULL | Название достижения |
|  | description | TEXT | NOT NULL | Описание достижения |
|  | criteria | JSONB | NOT NULL | Критерии получения (тип и порог) |
| **UserAchievements** | user_id | UUID | FK -> users(id) | Пользователь |
|  | achievement_id | UUID | FK -> achievements(id) | Достижение |
|  | progress | INTEGER | DEFAULT 0 | Текущий прогресс |
|  | achieved | BOOLEAN | DEFAULT FALSE | Флаг получения |
|  | achieved_date | TIMESTAMP | NULL | Дата получения |
| **ErrorReports** | error_report_id | UUID | PK | Уникальный идентификатор отчета об ошибке |
|  | user_id | UUID | FK -> users(id) | Автор отчета об ошибке |
|  | material_id | UUID | FK -> materials(id) | Ссылка на материал |
|  | description | VARCHAR(1024) | NOT NULL | Описание найденной ошибки |
|  | is_fixed | BOOLEAN | DEFAULT FALSE | Статус ошибки (исправлена ли?) |

**Особенности:**

- Поле `grammar_breakdown` содержит структурированное объяснение грамматики, иероглифов и культурных нюансов
- Поле `notes` в personal_dictionary позволяет пользователям добавлять собственные заметки к словам
- Поле `criteria` в achievements хранит условия получения в формате JSON (например: `{"type": "words_added", "threshold": 50}`)

### Связи

| Связь | Кардинальность | Описание |
|-------|----------------|----------|
| Users - Materials | 1:N | Один пользователь может создать много материалов |
| Materials - MaterialBlocks | 1:N | Один материал содержит много блоков |
| Users - PersonalDictionaries | 1:N | Один пользователь может иметь много слов в словаре |
| Users - UserAchievements | 1:N | Один пользователь может иметь много достижений |
| Users - ErrorReports | 1:N | Один пользователь может создать много отчетов |

![erd.svg]() (TODO)

---

## 5. Отслеживание прогресса достижений

**Решение:** Сервис трекинга достижений на основе событий

Вместо сложных вебхуков предлагается реализовать простой сервис, который:

1. **Генерирует события** при ключевых действиях пользователя:
   - `word_added_to_dictionary`
   - `material_viewed`
   - `error_reported`
   - `achievement_earned`

2. **Обрабатывает события** в фоновом режиме:
   - Обновляет прогресс в таблице `UserAchievements`
   - Проверяет условия получения достижений
   - Отправляет уведомления о полученных достижениях

3. **Архитектура:**
   - Frontend отправляет события через API (`POST /api/events`)
   - Backend обрабатывает события асинхронно
   - Используется паттерн "Наблюдатель" для гибкости

**Преимущества:**

- Простая реализация
- Легко добавлять новые типы достижений
- Низкая связанность компонентов
- Возможность масштабирования

---

## 6. UX/UI принципы

| Принцип | Реализация |
|---------|------------|
| **Трехколоночный layout** | Оригинал / Перевод / Разбор для десктопа; вертикальный стек для мобильных устройств |
| **Интерактивные элементы** | Подсветка соответствий между блоками при наведении/клике |
| **Визуальная обратная связь** | Анимации при добавлении в словарь, получении достижений |
| **Адаптивность** | Полная поддержка мобильных устройств и планшетов |
| **Доступность** | Соответствие WCAG 2.1, правильные ARIA-атрибуты |
| **Цветовая палитра** | <span style="color: white; background-color: #a2d2ff">#a2d2ff</span> <span style="color: white; background-color: #bee2ff">#bee2ff</span> <span style="color: white; background-color: #faaac7">#faaac7</span> <span style="color: white; background-color: #ffc8dd">#ffc8dd</span> <span style="color: white; background-color: #cdb4db">#cdb4db</span> |

---

## 5. API Эндпоинты (Основные)

### Аутентификация

```bash
POST /api/auth/register
Content-Type: application/json
{
  "email": "user@example.com",
  "password": "password123"
}

POST /api/auth/login
Content-Type: application/json
{
  "email": "user@example.com",
  "password": "password123"
}

GET /api/auth/profile
Authorization: Bearer <token>
```

### Материалы

```bash
GET /api/materials
# Список материалов с фильтрацией

POST /api/materials
Authorization: Bearer <token>
# Создание нового материала

GET /api/materials/{id}
# Получение конкретного материала
```

### Словарь

```bash
GET /api/dictionary
Authorization: Bearer <token>
# Словарь пользователя

POST /api/dictionary
Authorization: Bearer <token>
# Добавление слова в словарь
```

## 8. TODO Sequence Diagram

**Назначение:** Диаграмма последовательности отображает процесс взаимодействия пользователя с системой при выполнении ключевых сценариев, таких как:

- Просмотр материала и добавление слова в словарь.
- Отслеживание прогресса достижений.
- Создание нового материала модератором.

![sequence-diagram.svg]()

## 9. Бэклог (Jira)

### [EPIC-01] Базовая инфраструктура

- [US-1.1] Настройка среды разработки и CI/CD
- [US-1.2] Докеризация приложения (Dockerfile + docker-compose)
- [US-1.3] Написание документации для разработчиков

### [EPIC-02] Аутентификация и авторизация

- [US-2.1] Регистрация по email и паролю
- [US-2.2] Вход в систему
- [US-2.3] Просмотр и редактирование профиля пользователя

### [EPIC-03] Управление учебными материалыми

- [US-3.1] Создание и редактирование материалов (CRUD)
- [US-3.2] Система статусов материалов (черновик/опубликовано/архив)
- [US-3.3] Просмотр материалов с фильтрацией по сложности
- [US-3.4] Трехпанельный интерфейс просмотра материалов

### [EPIC-04] Личный словарь и прогресс

- [US-4.1] Добавление слов в личный словарь
- [US-4.2] Просмотр и управление словарем
- [US-4.3] Система достижений (15+ achievements)
- [US-4.4] Отслеживание прогресса обучения

### [EPIC-05] Модерация и администрирование

- [US-5.1] Система отчетов об ошибках
- [US-5.2] Управление пользователями и ролями
- [US-5.3] Модерация контента

### [EPIC-06] Документация и API

- [US-6.1] Swagger-документация API
- [US-6.2] Техническая документация для разработчиков

## 6. Тестирование

- **Юнит-тесты:** Покрытие основных модулей Go (60%+)
- **Интеграционные тесты:** Тестирование API эндпоинтов
- **E2E тесты:** Критические пользовательские сценарии

## 7. Деплой и инфраструктура

- **Локальная разработка:** Docker Compose
- **Боевой сервер:** VPS с Docker
- **База данных:** PostgreSQL в отдельном контейнере
- **Reverse proxy:** Nginx для статики и балансировки

## 8. Требования к коду

| Тип коммита | Описание |
|-------------|----------|
| `feat` | Новая функциональность |
| `fix` | Исправление ошибки |
| `docs` | Изменения в документации |
| `style` | Изменения форматирования |
| `refactor` | Рефакторинг кода |
| `test` | Добавление тестов |
| `chore` | Вспомогательные задачи |

## 9. Критерии приёмки MVP

| Функциональность | Критерий завершения |
|------------------|---------------------|
| **Регистрация и аутентификация** | Пользователь может создать аккаунт и войти в систему |
| **Управление материалами** | Модератор может создавать и публиковать материалы |
| **Просмотр материалов** | Пользователь может просматривать материалы в трех колонках |
| **Личный словарь** | Пользователь может добавлять слова в словарь |
| **Система достижений** | Реализовано 15 достижений с отслеживанием прогресса |
| **Отчеты об ошибках** | Пользователь может отправить отчет об ошибке |
| **Базовый UI** | Реализован адаптивный интерфейс |
